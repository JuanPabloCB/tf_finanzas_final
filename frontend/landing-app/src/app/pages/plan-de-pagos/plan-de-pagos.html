<!-- src/app/pages/plan-de-pagos/plan-de-pagos.html -->
<div class="plan-page">
  <!-- HEADER -->
  <header class="topbar">
    <div class="logo" routerLink="/dashboard">
      <div class="logo-icon"></div>
      <div class="logo-text">
        <span>urea</span>
        <span>Inmobiliaria</span>
      </div>
    </div>

    <div class="user-actions">
      <span class="user-name">{{ username }}</span>
      <button type="button" class="btn-logout" (click)="goToDashboard()">
        Volver al dashboard
      </button>
    </div>
  </header>

  <!-- CONTENIDO PRINCIPAL -->
  <main class="content">
    <section class="plan-card">
      <!-- HEADER DEL CARD -->
      <div class="plan-header">
        <div class="plan-header-left">
          <h1>Plan de pagos</h1>
          <p class="subtitle">
            Selecciona una simulaci贸n guardada y revisa su cronograma de pagos.
          </p>
        </div>

        <div class="plan-header-right" *ngIf="cronograma && cronograma.length > 0">
          <p class="total-cuotas">
            Total de cuotas:
            <strong>{{ cronograma.length }}</strong>
          </p>
          <button
            type="button"
            class="btn-download"
            (click)="descargarCSV()"
          >
             Descargar CSV
          </button>
        </div>
      </div>

      <!-- SELECTOR DE SIMULACIN -->
      <div
        class="sim-selector"
        *ngIf="simulaciones && simulaciones.length > 0"
      >
        <div class="selector-main">
          <label for="simSelect">Simulaci贸n guardada</label>
          <select
            id="simSelect"
            [(ngModel)]="selectedSimId"
            (ngModelChange)="onSimulationChange()"
          >
            <option *ngFor="let sim of simulaciones" [ngValue]="sim.id">
              {{ sim.nombre }}
            </option>
          </select>
        </div>

        <p class="sim-meta" *ngIf="selectedSim">
          {{ selectedSim.fecha | date:'short' }} 路
          {{ selectedSim.cliente || 'Cliente' }} 路
          {{ selectedSim.inmueble || 'Inmueble' }}
        </p>
      </div>

      <!-- ======= ESTADO VACO ======= -->
      <div
        class="empty-state"
        *ngIf="(!simulaciones || simulaciones.length === 0) || !mostrarTabla || !cronograma || cronograma.length === 0"
      >
        <div class="empty-icon"></div>

        <ng-container *ngIf="!simulaciones || simulaciones.length === 0; else haySimulaciones">
          <h2>No hay simulaciones guardadas</h2>
          <p>
            Genera una simulaci贸n de cr茅dito y gu谩rdala para visualizar aqu铆 su plan de pagos.
          </p>
        </ng-container>

        <ng-template #haySimulaciones>
          <h2>No hay cronograma para mostrar</h2>
          <p>
            Selecciona una simulaci贸n de la lista para ver su plan de pagos.
          </p>
        </ng-template>

        <button
          type="button"
          class="btn-primary"
          routerLink="/simulaciones/crear"
        >
          Ir a simulaci贸n
        </button>
      </div>

      <!-- ======= TABLA DE CRONOGRAMA ======= -->
      <div
        class="plan-body"
        *ngIf="mostrarTabla && cronograma && cronograma.length > 0"
      >
        <div class="table-wrapper">
          <table class="cronograma-table">
            <thead>
              <tr>
                <th>N掳</th>
                <th>Saldo inicial</th>
                <th>Inter茅s</th>
                <th>Amortizaci贸n</th>
                <th>Seg. desgravamen</th>
                <th>Seg. riesgo</th>
                <th>Gastos</th>
                <th>Cuota total</th>
                <th>Saldo final</th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="let pago of cronograma; let i = index"
                [class.alt-row]="i % 2 === 1"
              >
                <td class="numero">{{ pago.n }}</td>
                <td class="moneda">
                  {{ formatCurrency(pago.saldo_inicial) }}
                </td>
                <td class="moneda">
                  {{ formatCurrency(pago.interes) }}
                </td>
                <td class="moneda">
                  {{ formatCurrency(pago.amortizacion) }}
                </td>
                <td class="moneda">
                  {{ formatCurrency(pago.seguro_desgravamen) }}
                </td>
                <td class="moneda">
                  {{ formatCurrency(pago.seguro_riesgo) }}
                </td>
                <td class="moneda">
                  {{ formatCurrency(pago.gastos) }}
                </td>
                <td class="moneda cuota-total">
                  {{ formatCurrency(pago.cuota_total) }}
                </td>
                <td class="moneda saldo-final">
                  {{ formatCurrency(pago.saldo_final) }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ======= RESUMEN FINAL ======= -->
        <div class="resumen-footer">
          <div class="resumen-item">
            <span>Total intereses</span>
            <strong>{{ formatCurrency(totalIntereses) }}</strong>
          </div>
          <div class="resumen-item">
            <span>Total amortizaci贸n</span>
            <strong>{{ formatCurrency(totalAmortizacion) }}</strong>
          </div>
          <div class="resumen-item">
            <span>Total de cuotas pagadas</span>
            <strong>{{ formatCurrency(totalCuotas) }}</strong>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>
